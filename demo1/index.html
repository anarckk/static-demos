<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0">
    <title>发送方</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/rxjs@7.8.1/dist/bundles/rxjs.umd.min.js"></script>
    <script src="util.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div style="width: 100%;"><button>连接</button><button>断开</button></div>
    <div>myid is [<span id="myId">正在加载中</span>]</div>
    <div>连接到配置中心: <input style="width: 350px;" /></div>
    <div style="height: 800px;border: 1px solid black; margin: 20px;">
        <div style="float: right;border: 1px solid green;height: 100%;width: 200px;">
            <div>当前连接方</div>
            <!-- <div style="font-size: 12px;background-color: bisque;margin-bottom: 10px;">a5cb6a46-d146-4d4e-9ee3-be729921e53f</div> -->
        </div>
        <div style="margin-right: 210px;height: 100%;">
            <div>消息日志</div>
            <div id="history-box"
                style="height:650px; border: 1px solid pink; padding: 10px;overflow-y: auto;overflow-x:visible;">

            </div>
            <div>发送方&nbsp;&nbsp;<button id="send-btn">发送</button></div>
            <textarea style="width:100%;height: 100px;" id="send-textare"></textarea>
        </div>
    </div>
    <script>
        let TOTAL_CONFIG;
        function setMyId(id) {
            $("#myId").text(id);
            localStorage.myId = id;
        }
        function systemMessage(msg) { // TODO 还要防止xss注入
            var template = `
                <div style="margin-bottom: 10px;">
                    <div style="color: red;font-size: 12px;">{time}</div>
                    <div style="color: red;max-width: 100%;">{content}</div>
                </div>
            `;
            template = template.replace('{time}', dateFormat(new Date(), "yyyy-MM-dd HH:mm:ss"));
            template = template.replace('{content}', msg);
            $("#history-box").append(template);
        }

        var peerManager = function () {
            let userList = [];
            let peer;
            return {
                updateUserList: function (_userList) {
                    let newUserList = _userList.filter(_id => userList.filter(id => _id == id).length == 0);
                    let offlineUserList = userList.filter(id => _userList.filter(_id => _id == id).length == 0);
                    if (newUserList.length > 0) {
                        systemMessage("接收到 " + newUserList.length + "个用户上线");
                        newUserList.forEach(_id => {
                            systemMessage("尝试连接到用户 " + _id);
                            let dataConnection = peer.connect(_id);
                            dataConnection.on('data', function (data) {
                                console.log('dataConnection data', dataConnection.peer, data);
                            });
                            dataConnection.on('open', function (e) {
                                console.log('dataConnection open', e);
                                systemMessage("已连接到用户 " + _id);
                            });
                            dataConnection.on('close', function (e) {
                                console.log('dataConnection close', e);
                                systemMessage("断开用户 " + _id);
                            });
                            dataConnection.on('error', function (err) {
                                console.log('dataConnection error', err);
                            });
                        })
                    }
                    if (offlineUserList.length > 0) {
                        systemMessage("接收到 " + offlineUserList.length + "个用户下线");
                    }
                },
                setPeer: function (_peer) {
                    peer = _peer;
                }
            }
        }();
        function connectConfigCenter(peer, configId) {
            systemMessage("正在连接配置中心");
            let ask = 0;
            let timer;
            let dataConnection = peer.connect(configId);
            let configIsOpen = false;
            dataConnection.on('data', function (data) {
                if (data.type == TOTAL_CONFIG.MSG_TYPE.ASK_ALIVE) {
                    dataConnection.send({ type: TOTAL_CONFIG.MSG_TYPE.REPLAY_ALIVE });
                    return;
                }
                if (data.type == TOTAL_CONFIG.MSG_TYPE.REPLAY_ALIVE) {
                    ask--;
                    return;
                }
                if (data.type = TOTAL_CONFIG.MSG_TYPE.USER_LIST) {
                    peerManager.updateUserList(data.value);
                }
                console.log('dataConnection data', dataConnection.peer, data);
            });
            dataConnection.on('open', function (e) {
                console.log('dataConnection open', e);
                configIsOpen = true;
                systemMessage("已连接到配置中心 " + dataConnection.peer);
                timer = setInterval(() => {
                    if (ask > 1) {
                        console.log('判断该连接失活');
                        dataConnection.close();
                    } else {
                        dataConnection.send({ type: TOTAL_CONFIG.MSG_TYPE.ASK_ALIVE });
                        ask++;
                    }
                }, 1000);
            });
            dataConnection.on('close', function (e) {
                console.log('dataConnection close', e);
                configIsOpen = false;
                systemMessage("断开配置中心");
                if (timer) clearInterval(timer);
                ask = 0;
            });
            dataConnection.on('error', function (err) {
                console.log('dataConnection error', err);
            });
            return {
                configIsOpen: () => configIsOpen,
                close: () => dataConnection.close(),
            }
        }

        function start(myId) {
            let peerIsOpen = false;
            systemMessage("正在启动中...");
            var peer = new Peer(myId);
            peerManager.setPeer(peer);
            peer.on('open', function (id) {
                console.log('peer open', id);
                systemMessage("加载到了自己的id " + id);
                setMyId(id);
                peerIsOpen = true;
                connectConfigCenter(peer, TOTAL_CONFIG.config_id);
            });
            peer.on('connection', function (dataConnection) {
                console.log('peer connection', dataConnection);
                dataConnection.on('data', function (data) {
                    console.log('dataConnection data', data);
                    console.log(dataConnection.id, data);
                });
                dataConnection.on('open', function (e) {
                    console.log('dataConnection open', e);
                });
                dataConnection.on('close', function (e) {
                    console.log('dataConnection close', e);
                });
                dataConnection.on('error', function (err) {
                    console.log('dataConnection error', err);
                });
            });
            peer.on('call', function (mediaConnection) {
                console.log('peer call', mediaConnection);
            });
            peer.on('close', function (e) {
                console.log('peer close', e);
                peerIsOpen = false;
            });
            peer.on('disconnected', function (e) {
                console.log('peer disconnected', e);
                systemMessage("peer disconnected " + e);
                peer.reconnect();
                peerIsOpen = false;
            });
            peer.on('error', function (err) {
                console.error('peer error', err.type, err);
            });

            var conn;
            $("#connect-btn").click(function () {
                $("#status-span").text("正在连接对方");
                conn = peer.connect($("#otherId").val());
                conn.on('open', function () {
                    $("#status-span").text("连接成功!");
                    conn.on('data', function (data) {
                        $("#receiveHistory").append("<div>" + data + "</div>");
                    });
                });
            })
            $("#send-btn").click(() => {
                conn.send($("#send-textare").val());
                $("#history-box").append("<div>" + $("#send-textare").val() + "</div>");
                $("#send-textare").val("");
            });
            return {
                peerIsOpen: () => peerIsOpen,
                close: () => dataConnection.close(),
            }
        }
        getConfig().subscribe(_TOTAL_CONFIG => {
            TOTAL_CONFIG = _TOTAL_CONFIG;
            start(localStorage.myId || undefined);
        });
    </script>
</body>

</html>