<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>配置中心</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/rxjs@7.8.1/dist/bundles/rxjs.umd.min.js"></script>
    <script src="util.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div>myid is [<span id="myId">正在加载中</span>]</div>
    <div id="content"></div>
    <script>
        getConfig().subscribe(TOTAL_CONFIG => {
            console.log('连接配置中心', TOTAL_CONFIG.config_id);
            var connList = [];
            function rerenderConnList() {
                $("#content").html(JSON.stringify(connList.map(f => Object.assign({}, { id: f.id })), null, 2));
            }

            function connUpdate() {
                connList.forEach(li => {
                    li.conn.send({
                        type: TOTAL_CONFIG.MSG_TYPE.USER_LIST,
                        value: connList
                            .filter(f => f.id != li.id)
                            .map(f => Object.assign({}, { id: f.id }))
                    });
                });
            }

            rerenderConnList();
            var peer = new Peer(TOTAL_CONFIG.config_id);
            peer.on('open', function (id) {
                console.log('peer open', id);
                $("#myId").text(id);
            });
            peer.on('connection', function (dataConnection) {
                let ask = 0;
                let timer;
                console.log('peer connection', dataConnection);
                dataConnection.on('data', function (data) {
                    if (data.type == TOTAL_CONFIG.MSG_TYPE.ASK_ALIVE) {
                        dataConnection.send({ type: TOTAL_CONFIG.MSG_TYPE.REPLAY_ALIVE });
                        return;
                    }
                    if (data.type == TOTAL_CONFIG.MSG_TYPE.REPLAY_ALIVE) {
                        ask--;
                        return;
                    }
                    console.log('dataConnection data', dataConnection.peer, data);
                });
                dataConnection.on('open', function (e) {
                    console.log('dataConnection open', e);
                    connList.push({ id: dataConnection.peer, conn: dataConnection });
                    console.log(connList);
                    rerenderConnList();
                    timer = setInterval(() => {
                        if (ask > 1) {
                            console.log('判断该连接失活');
                            dataConnection.close();
                        } else {
                            dataConnection.send({ type: TOTAL_CONFIG.MSG_TYPE.ASK_ALIVE });
                            ask++;
                        }
                    }, 1000);
                    connUpdate();
                });
                dataConnection.on('close', function (e) {
                    console.log('dataConnection close', e);
                    connList = connList.filter(f => f.id != dataConnection.peer);
                    connUpdate();
                    rerenderConnList();
                    if (timer) clearInterval(timer);
                    ask = 0;
                });
                dataConnection.on('error', function (err) {
                    console.log('dataConnection error', err);
                });
            });
            peer.on('call', function (mediaConnection) {
                console.log('peer call', mediaConnection);
            });
            peer.on('close', function (e) {
                console.log('peer close', e);
            });
            peer.on('disconnected', function (e) {
                console.log('peer disconnected', e);
                peer.reconnect();
            });
            peer.on('error', function (err) {
                console.error('peer error', err);
            });
        });
    </script>
</body>

</html>